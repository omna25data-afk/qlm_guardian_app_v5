# متطلبات تحسين تبويب القيود (المحررات)

## 1. وصف الميزة

بناءً على طلب المستخدم، الهدف هو تحسين وتطوير تبويب "القيود" وشاشة عرض وإضافة وتعديل القيد (النموذج المقسم). يشمل ذلك التأكد من أن جميع الحقول الديناميكية للأنواع السبعة من المحررات يتم حفظها واسترجاعها بدقة، مع عرض جميع البيانات وعرض جميع القيود (تجاوز حاجز الـ 10 قيود الحالي).

## 2. المتطلبات الوظيفية (Business Requirements)

### 2.1. جلب وعرض البيانات الكاملة للأنواع السبعة (Form Data)

- **المشكلة الحالية:** لا تظهر الحقول الديناميكية (مثل تفاصيل زواج، طلاق، مبيعات، إلخ) عند العرض أو التعديل، بسبب عدم ربط `contract_details` القادمة من الباكند بحقل `formData` في الموديل.
- **الحل:** في `RegistryEntrySections.dart`، يجب تعيين `formData` لتقرأ من `json['contract_details']` بدلاً من `json['form_data']` (أو كليهما لدعم التوافقية).
- **التأثير:** سيتم توفير جميع تفاصيل القيد من الجداول الفرعية بناءً على `id` السجل المركزي.

### 2.2. حل مشكلة اقتصار العرض على 10 قيود (Pagination)

- **المشكلة الحالية:** الباكند يوفر 10 قيود لكل صفحة (Pagination)، ولكن في `AllEntriesNotifier` لا توجد آلية لجلب الصفحة الثانية وما بعدها.
- **الحل:**
  - تحويل `allEntriesProvider` ليدعم الـ Infinite Scrolling أو تعديل `fetchEntries`.
  - إضافة `ScrollController` لـ ListView في `all_entries_tab.dart` لبدء جلب الصفحة التالية عند الاقتراب من نهاية القائمة.

### 2.3. تحسين صفحة العرض

- **المشكلة الحالية:** عند الضغط على الكارت، يتم فتح `RegistryEntryCorrectionDialog` وهو نموذج تصحيح مبسط ولا يعرض جميع الحقول الديناميكية.
- **الحل:**
  - توفير شاشة مخصصة للعرض `ViewRegistryEntryScreen` تعرض بيانات القيد بشكل مقسم ومنظم (مثل التصميم المقسم)، بما في ذلك الحقول الديناميكية.
  - سيتم فتح شاشة العرض بدلاً من المودال عند النقر على الكارت من التبويب.

### 2.4. نموذج الإضافة والتعديل (النموذج المقسم)

- **المشكلة الحالية:** عند تعديل قيد مسبق (`CompactRegistryEntryScreen`) لا يتم تعبئة الحقول الديناميكية. واجهة التعديل غير مهيأة لإرسال رقم الـ ID للباكند.
- **الحل:**
  - في `CompactRegistryEntryScreen`، عند التعديل (`initialData != null`)، تعبئة `_dynamicControllers` من `formData`.
  - مراجعة إرسال `_submitForm()` ليقوم بتوجيه الطلب كـ التعديل `update` بدلاً من إضافة `store` إذا كان هناك `initialData`.
  - التحقق من ربط جميع الحقول بالـ Backend (إرسال واستقبال).

## 3. معايير القبول (Acceptance Criteria)

1. تمرير قائمة القيود للأسفل يجلب أكثر من 10 قيود بنجاح (Infinite Scroll).
2. فتح قيد مبيعات للعرض يعرض اسم البائع والمشتري وغيرها من الحقول للسجل المتفرع.
3. التعديل على قيد يملأ جميع الحقول القديمة في النموذج المقسم.
4. حفظ القيد المعدل يرسلها للباكند (إلى نقطة التعديل أو دمج مع إضافة إذا كان الباكند يدعم Upsert).

## 4. القيود التقنية (Constraints)

- يجب عدم كسر نماذج إضافة القيود الحالية.
- الاعتماد على `contract_details` لقراءة الحقول الديناميكية.
